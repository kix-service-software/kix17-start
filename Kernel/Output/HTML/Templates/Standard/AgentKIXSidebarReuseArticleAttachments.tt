# --
# Copyright (C) 2006-2021 c.a.p.e. IT GmbH, https://www.cape-it.de
# --
# This software comes with ABSOLUTELY NO WARRANTY. For details, see
# the enclosed file LICENSE for license information (AGPL). If you
# did not receive this file, see https://www.gnu.org/licenses/agpl.txt.
# --


<div id="ReuseArticleAttachments" class="WidgetSimple Collapsed CanDrag">
    <div class="Header">
        <div class="WidgetAction Toggle" title="[% Translate("Show or hide the content.") | html %]" id="ReuseArticleAttachmentsBlockOpen" aria-controls="Core_UI_AutogeneratedID_0" aria-expanded="false"></div>
        <h2><span>[% Translate(Data.Title) | html %]</span></h2>
    </div>
    <div class="Content">
        <div class="SearchBox">
          <fieldset class="TableLike FixedLabelSmall">
                <input class="Search" title="Search" name="SearchString" type="Text" size="25" value=""/>
                <button id="SearchBoxButton" type="submit" value="[% Translate("Search") | html %]" title="[% Translate("Search") | html %]"><i class="fa fa-search"></i></button>
         </fieldset>
        </div>
        <div id="ArticleAttachmentStrgContainer">
            [% Data.ArticleAttachmentStrg %]
        </div>
    </div>
</div>

[% WRAPPER JSOnDocumentComplete %]
<script type="text/javascript">//<![CDATA[

    function initReuseArticleAttachments() {
        $('input[name=ReuseArticleAttachmentID]').click(function() {
            var TicketID = $("input[name=TicketID]").val(),
                FormID   = $("input[name=FormID]").val(),
                URL      = '';
            if ($(this).prop('checked')) {
                URL = 'Action=ReuseArticleAttachmentsAJAXHandler;Subaction=AttachmentAdd;TicketID=' + TicketID + ';FormID=' + FormID + ';AttachmentID=' + $(this).val();
                Core.AJAX.FunctionCall(Core.Config.Get('CGIHandle'), URL, function () {}, 'text', true);
            }
            else {
                URL = 'Action=ReuseArticleAttachmentsAJAXHandler;Subaction=AttachmentRemove;TicketID=' + TicketID + ';FormID=' + FormID + ';AttachmentID=' + $(this).val();
                Core.AJAX.FunctionCall(Core.Config.Get('CGIHandle'), URL, function () {}, 'text', true);
            }
        });
        $('#SearchBoxButton').click(function(event) {
            var TicketID     = $("input[name=TicketID]").val(),
                FormID       = $("input[name=FormID]").val(),
                SearchString = $("#ReuseArticleAttachments input[name=SearchString]").val(),
                URL          = '';
            $('#ArticleAttachmentStrgContainer').html('<div class="Loader Center"></div>');
            URL = '[% Env("Baselink") %]Action=ReuseArticleAttachmentsAJAXHandler;Subaction=LoadAttachments;TicketID=' + TicketID + ";SearchString=" + SearchString + ';FormID=' + FormID;
            Core.AJAX.ContentUpdate($('#ArticleAttachmentStrgContainer'), URL, function () {
                initReuseArticleAttachments();
            });
            event.preventDefault();
        });

        Core.KIX4OTRS.KIXSidebar.ArticleAttachmentPager();
    }

    initReuseArticleAttachments();

    $('#ReuseArticleAttachments .WidgetAction.Toggle').on('click', function() {
        // load attachments on first expand
        if ($('#ReuseArticleAttachments').hasClass('Expanded')) {
            var TicketID = $("input[name=TicketID]").val(),
                FormID   = $("input[name=FormID]").val(),
                URL      = '';
            $('#ArticleAttachmentStrgContainer').html('<div class="Loader Center"></div>');
            URL = '[% Env("Baselink") %]Action=ReuseArticleAttachmentsAJAXHandler;Subaction=LoadAttachments;TicketID=' + TicketID + ';FormID=' + FormID;
            Core.AJAX.ContentUpdate($('#ArticleAttachmentStrgContainer'), URL, function () {
                initReuseArticleAttachments();
            });
        }
    });
//]]></script>
[% END %]